defmodule XcrapperWeb.PageControllerTest do
  use XcrapperWeb.ConnCase

  test "GET /", %{conn: conn} do
    conn = get(conn, ~p"/")

    # Some variables as the tokens changes, so we use a set diff to check the similarity between the two docs
    # if it's above 94% we assume they are similar

    fixture_answer_set =
      "<!DOCTYPE html>\n<html lang=\"en\" class=\"[scrollbar-gutter:stable]\">\n  <head>\n    <meta charset=\"utf-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n    <meta name=\"csrf-token\" content=\"LzRAaG9lA0ELXkMOGRg4Y3kEWDo8bQYaIbw1_VU5Hfnb_bj2Oc9lhYTi\">\n    <title data-suffix=\" · Phoenix Framework\">\nXcrapper\n     · Phoenix Framework</title>\n    <link phx-track-static rel=\"stylesheet\" href=\"/assets/app.css\">\n    <script defer phx-track-static type=\"text/javascript\" src=\"/assets/app.js\">\n    </script>\n  </head>\n  <body class=\"bg-white antialiased\">\n<div data-phx-main data-phx-session=\"SFMyNTY.g2gDaAJhBXQAAAAIdwJpZG0AAAAUcGh4LUY5UjRJUmh5ZklzUU53Qk13B3Nlc3Npb250AAAAAHcKcGFyZW50X3BpZHcDbmlsdwR2aWV3dyNFbGl4aXIuWGNyYXBwZXJXZWIuU2Vzc2lvbkxpdmUuUG9zdHcIcm9vdF9waWR3A25pbHcGcm91dGVydxlFbGl4aXIuWGNyYXBwZXJXZWIuUm91dGVydwxsaXZlX3Nlc3Npb25oAncHZGVmYXVsdG4IAGBiFySfd9QXdwlyb290X3ZpZXd3I0VsaXhpci5YY3JhcHBlcldlYi5TZXNzaW9uTGl2ZS5Qb3N0bgYA0_DjzI8BYgABUYA.CUhwUM0uh9s0AljUAzEqESqEC3KeEevWPn2i4Uzyse4\" data-phx-static=\"SFMyNTY.g2gDaAJhBXQAAAADdwJpZG0AAAAUcGh4LUY5UjRJUmh5ZklzUU53Qk13BWZsYXNodAAAAAB3CmFzc2lnbl9uZXdqbgYA2PDjzI8BYgABUYA.H84d_obgs0t8qfWtqNvtWtPxMTVPkdrNAwnQQzeRgAM\" id=\"phx-F9R4IRhyfIsQNwBM\"><header class=\"px-4 sm:px-6 lg:px-8\">\n  <div class=\"flex items-center justify-between border-b border-zinc-100 py-3 text-sm\">\n    <div class=\"flex items-center gap-4\">\n      <a href=\"/\">\n        <img src=\"/images/logo.svg\" width=\"36\">\n      </a>\n      <p class=\"bg-brand/5 text-brand rounded-full px-2 font-medium leading-6\">\n        v1.7.12\n      </p>\n    </div>\n    <div>\n<div data-phx-session=\"\" data-phx-static=\"SFMyNTY.g2gDaAJhBXQAAAADdwJpZG0AAAAGbG9nb3V0dwVmbGFzaHQAAAAAdwphc3NpZ25fbmV3am4GAPHw48yPAWIAAVGA.h7jIJDgZ7KK_pSO9HIGPNVhCauqluTnBvbi8eb93H5w\" data-phx-parent-id=\"phx-F9R4IRhyfIsQNwBM\" id=\"logout\"></div>\n    </div>\n  </div>\n</header>\n<main class=\"px-4 py-20 sm:px-6 lg:px-8\">\n  <div class=\"mx-auto max-w-2xl\">\n    \n\n<div id=\"client-error\" phx-click=\"[[&quot;push&quot;,{&quot;value&quot;:{&quot;key&quot;:&quot;error&quot;},&quot;event&quot;:&quot;lv:clear-flash&quot;}],[&quot;hide&quot;,{&quot;time&quot;:200,&quot;to&quot;:&quot;#client-error&quot;,&quot;transition&quot;:[[&quot;transition-all&quot;,&quot;transform&quot;,&quot;ease-in&quot;,&quot;duration-200&quot;],[&quot;opacity-100&quot;,&quot;translate-y-0&quot;,&quot;sm:scale-100&quot;],[&quot;opacity-0&quot;,&quot;translate-y-4&quot;,&quot;sm:translate-y-0&quot;,&quot;sm:scale-95&quot;]]}]]\" role=\"alert\" class=\"fixed top-2 right-2 w-80 sm:w-96 z-50 rounded-lg p-3 ring-1 bg-rose-50 text-rose-900 shadow-md ring-rose-500 fill-rose-900\" hidden phx-connected=\"[[&quot;hide&quot;,{&quot;time&quot;:200,&quot;to&quot;:&quot;#client-error&quot;,&quot;transition&quot;:[[&quot;transition-all&quot;,&quot;transform&quot;,&quot;ease-in&quot;,&quot;duration-200&quot;],[&quot;opacity-100&quot;,&quot;translate-y-0&quot;,&quot;sm:scale-100&quot;],[&quot;opacity-0&quot;,&quot;translate-y-4&quot;,&quot;sm:translate-y-0&quot;,&quot;sm:scale-95&quot;]]}]]\" phx-disconnected=\"[[&quot;show&quot;,{&quot;display&quot;:null,&quot;time&quot;:200,&quot;to&quot;:&quot;.phx-client-error #client-error&quot;,&quot;transition&quot;:[[&quot;transition-all&quot;,&quot;transform&quot;,&quot;ease-out&quot;,&quot;duration-300&quot;],[&quot;opacity-0&quot;,&quot;translate-y-4&quot;,&quot;sm:translate-y-0&quot;,&quot;sm:scale-95&quot;],[&quot;opacity-100&quot;,&quot;translate-y-0&quot;,&quot;sm:scale-100&quot;]]}]]\">\n  <p class=\"flex items-center gap-1.5 text-sm font-semibold leading-6\">\n    \n    <span class=\"hero-exclamation-circle-mini h-4 w-4\"></span>\n    We can&#39;t find the internet\n  </p>\n  <p class=\"mt-2 text-sm leading-5\">\n  Attempting to reconnect <span class=\"hero-arrow-path ml-1 h-3 w-3 animate-spin\"></span>\n</p>\n  <button type=\"button\" class=\"group absolute top-1 right-1 p-2\" aria-label=\"close\">\n    <span class=\"hero-x-mark-solid h-5 w-5 opacity-40 group-hover:opacity-70\"></span>\n  </button>\n</div>\n\n<div id=\"server-error\" phx-click=\"[[&quot;push&quot;,{&quot;value&quot;:{&quot;key&quot;:&quot;error&quot;},&quot;event&quot;:&quot;lv:clear-flash&quot;}],[&quot;hide&quot;,{&quot;time&quot;:200,&quot;to&quot;:&quot;#server-error&quot;,&quot;transition&quot;:[[&quot;transition-all&quot;,&quot;transform&quot;,&quot;ease-in&quot;,&quot;duration-200&quot;],[&quot;opacity-100&quot;,&quot;translate-y-0&quot;,&quot;sm:scale-100&quot;],[&quot;opacity-0&quot;,&quot;translate-y-4&quot;,&quot;sm:translate-y-0&quot;,&quot;sm:scale-95&quot;]]}]]\" role=\"alert\" class=\"fixed top-2 right-2 w-80 sm:w-96 z-50 rounded-lg p-3 ring-1 bg-rose-50 text-rose-900 shadow-md ring-rose-500 fill-rose-900\" hidden phx-connected=\"[[&quot;hide&quot;,{&quot;time&quot;:200,&quot;to&quot;:&quot;#server-error&quot;,&quot;transition&quot;:[[&quot;transition-all&quot;,&quot;transform&quot;,&quot;ease-in&quot;,&quot;duration-200&quot;],[&quot;opacity-100&quot;,&quot;translate-y-0&quot;,&quot;sm:scale-100&quot;],[&quot;opacity-0&quot;,&quot;translate-y-4&quot;,&quot;sm:translate-y-0&quot;,&quot;sm:scale-95&quot;]]}]]\" phx-disconnected=\"[[&quot;show&quot;,{&quot;display&quot;:null,&quot;time&quot;:200,&quot;to&quot;:&quot;.phx-server-error #server-error&quot;,&quot;transition&quot;:[[&quot;transition-all&quot;,&quot;transform&quot;,&quot;ease-out&quot;,&quot;duration-300&quot;],[&quot;opacity-0&quot;,&quot;translate-y-4&quot;,&quot;sm:translate-y-0&quot;,&quot;sm:scale-95&quot;],[&quot;opacity-100&quot;,&quot;translate-y-0&quot;,&quot;sm:scale-100&quot;]]}]]\">\n  <p class=\"flex items-center gap-1.5 text-sm font-semibold leading-6\">\n    \n    <span class=\"hero-exclamation-circle-mini h-4 w-4\"></span>\n    Something went wrong!\n  </p>\n  <p class=\"mt-2 text-sm leading-5\">\n  Hang in there while we get back on track\n  <span class=\"hero-arrow-path ml-1 h-3 w-3 animate-spin\"></span>\n</p>\n  <button type=\"button\" class=\"group absolute top-1 right-1 p-2\" aria-label=\"close\">\n    <span class=\"hero-x-mark-solid h-5 w-5 opacity-40 group-hover:opacity-70\"></span>\n  </button>\n</div>\n<div>\n  <form phx-submit=\"login\">\n    <input id=\"username\" name=\"username\" placeholder=\"Username\" required>\n    <input id=\"password\" name=\"password\" type=\"password\" placeholder=\"Password\" required>\n    <button type=\"submit\" class=\"phx-submit-loading:opacity-75 rounded-lg bg-zinc-900 hover:bg-zinc-700 py-2 px-3 text-sm font-semibold leading-6 text-white active:text-white/80 \">\n  Login\n</button>\n  </form>\n  <div>\n    <button phx-click=\"register\" onclick=\"register()\" class=\"bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded\">\n      Do not have a user? Try to register here\n    </button>\n  </div>\n\n  <script>\n    function register() {\n      var registerButton = document.querySelector(\"[phx-click='register']\");\n      registerButton.setAttribute(\"phx-value-username\", document.getElementById(\"username\").value);\n      registerButton.setAttribute(\"phx-value-password\", document.getElementById(\"password\").value);\n    }\n  </script>\n</div>\n  </div>\n</main></div>\n  </body>\n</html>"
      |> String.split(" ")
      |> MapSet.new()

    got_set =
      html_response(conn, 200)
      |> String.split(" ")
      |> MapSet.new()

    intersection = MapSet.intersection(fixture_answer_set, got_set)
    union = MapSet.union(fixture_answer_set, got_set)

    intersection_count = MapSet.size(intersection)
    union_count = MapSet.size(union)

    similarity = intersection_count / union_count

    assert similarity > 0.94
  end
end
